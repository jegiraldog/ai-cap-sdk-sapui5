<mvc:View controllerName="com.globant.aichat.aichatpdfui5.controller.Home"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:f="sap.f"
    xmlns:layout="sap.ui.layout">
    
    <f:DynamicPage id="dynamicPage" showFooter="true">
        <!-- Header -->
        <f:title>
            <f:DynamicPageTitle>
                <f:heading>
                    <HBox alignItems="Center">
                        <Avatar src="sap-icon://robot" 
                               displaySize="M" 
                               backgroundColor="Accent6" 
                               class="sapUiTinyMarginEnd"/>
                        <Title text="AI Chat Assistant" level="H2"/>
                    </HBox>
                </f:heading>
                <f:actions>
                    <Button text="Compartir" 
                           icon="sap-icon://share-2" 
                           type="Transparent"/>
                    <Button text="Nuevo Chat" 
                           icon="sap-icon://add" 
                           type="Emphasized"
                           press=".onNewChat"/>
                </f:actions>
            </f:DynamicPageTitle>
        </f:title>

        <!-- Content - Chat Area -->
        <f:content>
            <VBox height="100%" justifyContent="SpaceBetween">
                <!-- Model Selection - Compact Header -->
                <Bar class="sapUiTinyMarginBottom">
                    <contentLeft>
                        <Label text="Modelo:" class="sapUiTinyMarginEnd"/>
                        <ComboBox id="modelComboBox"
                                 placeholder="Seleccionar modelo..."
                                 items="{path: '/getAvailableModels'}"
                                 width="200px"
                                 selectedKey="{ui>/selectedModel}">
                            <core:Item key="{id}" text="{modelName}" />
                        </ComboBox>
                    </contentLeft>
                    <contentRight>
                        <Button icon="sap-icon://settings" 
                               type="Transparent" 
                               tooltip="Configuración"/>
                    </contentRight>
                </Bar>

                <!-- Chat Messages Area -->
                <ScrollContainer id="chatContainer"
                               height="100%"
                               vertical="true"
                               class="sapUiTinyMargin">
                    
                    <!-- Welcome Message when no messages -->
                    <VBox visible="{= ${chat>/messages}.length === 0}" 
                          alignItems="Center" 
                          justifyContent="Center"
                          class="sapUiMediumMarginTop">
                        <core:Icon src="sap-icon://robot" 
                                  size="3rem" 
                                  color="Positive"
                                  class="sapUiSmallMarginBottom"/>
                        <Title text="¡Hola! ¿En qué puedo ayudarte hoy?" 
                              level="H4" 
                              textAlign="Center"
                              class="sapUiSmallMarginBottom"/>
                        <Text text="Selecciona un modelo y comienza a chatear" 
                             textAlign="Center"/>
                    </VBox>

                    <!-- Chat Messages - Debug Version -->
                    <VBox items="{chat>/messages}" class="sapUiTinyMargin">
                        
                        <VBox class="sapUiTinyMarginBottom">
                            <!-- User Message -->
                            <VBox visible="{= ${chat>type} === 'user'}">
                                <FlexBox justifyContent="End" class="sapUiTinyMarginBottom">
                                    <MessageStrip 
                                        text="{chat>text}" 
                                        type="Information" 
                                        showIcon="false"
                                        tooltip="{chat>fullTimestamp}"
                                        class="sapUiNoMargin">
                                        <layoutData>
                                            <FlexItemData growFactor="0" shrinkFactor="1" baseSize="65%"/>
                                        </layoutData>
                                    </MessageStrip>
                                </FlexBox>
                            </VBox>

                            <!-- Assistant Message -->
                            <VBox visible="{= ${chat>type} === 'assistant'}">
                                <HBox justifyContent="Start" class="sapUiTinyMarginBottom">
                                    <Panel backgroundDesign="Transparent" width="95%">
                                        <content>
                                            <VBox class="sapUiTinyMargin">
                                                <!-- Assistant Header -->
                                                <HBox alignItems="Center" class="sapUiTinyMarginBottom">
                                                    <Avatar src="sap-icon://robot" 
                                                           displaySize="XS" 
                                                           backgroundColor="Accent6"
                                                           class="sapUiTinyMarginEnd"/>
                                                    <Text text="AI Assistant" class="sapUiSmallText"/>
                                                </HBox>
                                                
                                                <!-- Loading State -->
                                                <VBox visible="{chat>isLoading}">
                                                    <HBox alignItems="Center">
                                                        <BusyIndicator size="0.8rem" class="sapUiTinyMarginEnd"/>
                                                        <Text text="Generando respuesta..." class="sapUiSmallText"/>
                                                    </HBox>
                                                </VBox>
                                                
                                                <!-- Assistant Response -->
                                                <VBox visible="{= !${chat>isLoading}}">
                                                    <FormattedText htmlText="{path: 'chat>text', formatter: '.formatMarkdownToHtml'}" class="sapUiMediumText"/>
                                                    <Text text="{chat>timestamp}" class="sapUiTinyText"/>
                                                </VBox>
                                            </VBox>
                                        </content>
                                    </Panel>
                                </HBox>
                            </VBox>

                            <!-- Error Message -->
                            <VBox visible="{= ${chat>type} === 'error'}">
                                <HBox justifyContent="Center" class="sapUiTinyMarginBottom">
                                    <MessageStrip text="{chat>text}" type="Error" showIcon="true"/>
                                </HBox>
                            </VBox>
                        </VBox>

                    </VBox>
                </ScrollContainer>
            </VBox>
        </f:content>

        <!-- Footer - Input Area -->
        <f:footer>
            <OverflowToolbar>
                <ToolbarSpacer/>
                <TextArea id="chatInput"
                         placeholder="Escribe tu mensaje aquí..."
                         rows="1"
                         width="70%"
                         maxLength="4000"
                         growing="true"
                         growingMaxLines="4"
                         showExceededText="false"
                         liveChange=".onInputChange"/>
                <Button id="askButton"
                       icon="sap-icon://paper-plane"
                       type="Emphasized"
                       tooltip="Enviar mensaje"
                       press=".onAskQuestion"/>
                <ToolbarSpacer/>
            </OverflowToolbar>
        </f:footer>
    </f:DynamicPage>
</mvc:View>
